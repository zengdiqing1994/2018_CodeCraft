### 分析

2018年的华为软挑，考察了机器学习和云计算相关的知识，这里我们要根据上一周或者上几周客户申请的虚拟机的类型和相应的数量，预测出下一周或者一段时间之内各类型虚拟机的申请情况。在预测的基础上，用尽量少的数量的服务器去放置预测出来的所有虚拟机。

用一个通俗的例子来说，卖电脑的某宝店主，根据前两个三个月的电脑销售记录，推测接下来一周会有多少型号的电脑会被买走。

发货时候，希望用尽量少的箱子将这些电脑打包装好，再邮寄出去。

### 预测部分

预测部分说白了就是一个“拟合”问题，因为是结构化的数据，所以脑海里首先想到的是“线性回归”，然后发现，线性回归去拟合和预测数据，过于简单粗暴，很多细节都会丢失，也就是我们所说的“过拟合”，百分制的练习阶段，我们的成绩只有53-55，简直了。。。

后面考虑到减少“过拟合”的问题，使用局部加权回归，好像也没有多大改进，于是讨论出了下面的方法。

#### 指数平滑

经典的基于时序序列的预测问题，在金融领域利用的多的有“指数平滑”，“ARIMA”等，在现今火热的深度学习领域，LSTM也是首当其冲。我们采用了指数平滑的方法，分为一次，二次，三次指数平滑。

一次指数平滑![](https://img-blog.csdnimg.cn/20190219100039110.png)，其中，St是时间t+1期的预测值，即t期的平滑值；Yt为t期的实际值，St-1为t期的预测值，t-1期的平滑值；α为平滑系数，又称加权因子，取值范围为[0,1]，通常经过反复试算来确定α的最优值(最小均方误差)。

我们把![](https://img-blog.csdnimg.cn/20190219100550586.png)依次带入上式，可以得到下面的式子：

![](https://img-blog.csdnimg.cn/20190219100651640.png)

从上式中可以看出，一次指数平滑实际上是以![](https://img-blog.csdnimg.cn/20190219100759882.png)为权值的加权移动平均法。由于k越大，![](https://img-blog.csdnimg.cn/20190219100759882.png)越小，所以越是远期的实际值对未来时期平滑值的影响就越小。最后一项初始平滑值S0通常为最初几个实测值的平均值来替代。

二次指数平滑法其实就是对一次指数平滑法再多一次指数平滑，求出一次指数平滑值和二次指数平滑值得差值，然后将差值加到一次指数平滑值上，再加上趋势变动值便可得到近似于实际值的测量值。

机器学习离不了公式，结合本题目的场景：

假设我们获取了过去一段时间T(比如一年)内的虚拟机请求数据，我们以t(比如一个月)把时间段T进行等份划分，那么可以划分成I（如I=12）等份。

假设虚拟机的规格(flavor)集合为 F = {1,2,....f,...|F|}，共有|F|种不同规格的虚拟机类型(flavor)：假设所有规格的虚拟机增量集合为M={M1,M2,..M|F|},其中Mf=![](https://img-blog.csdnimg.cn/20190219101812738.png)，即![](https://img-blog.csdnimg.cn/20190219101932857.png)表示第f种规格的虚拟机在第i个t时间段内的增量，用![](https://img-blog.csdnimg.cn/20190219102058899.png)表示第i个t时间段内用户申请的规格为f的虚拟机数量，则有：

![](https://img-blog.csdnimg.cn/20190219102218923.png)

对Mf通过下面的公式可以得到一次指数平滑值：

![](https://img-blog.csdnimg.cn/20190219102416180.png)

而如果要对第i+n期的虚拟机数量增量进行预测，需要通过以下二次指数平滑预测模型：

![](https://img-blog.csdnimg.cn/20190219102623198.png)

并且二次指数平滑与一次指数平滑值得递推公式为：

![](https://img-blog.csdnimg.cn/20190219102820835.png)

这时候，对第I+1期进行预测，根据公式（5）可得：

![](https://img-blog.csdnimg.cn/2019021910300955.png)

由此可以得到第I+1期的虚拟机预测集合 ![](https://img-blog.csdnimg.cn/20190219103137537.png)，根据预测结果，可以计算虚拟机总数：

![](https://img-blog.csdnimg.cn/20190219103216189.png)

当然，依次类推，我们还可以得到三次指数平滑表达式，但并不是次数越高越好，得看具体训练数据集而定。本题中使用二次指数平滑效果是要比三次要好的。

### 放置阶段

由前一段时间的数据预测得到的各类型虚拟机的数量，需要有实际的物理服务器去存放这些虚拟机。这里我们使用的是首次适应(FF)和粒子群算法(PSO)去实现。

首次适应(FF)本来是操作系统当中内存分配作业的一种应用，就是由几个虚拟机就先放到服务器当中，然后根据某些条件来找到一个相对合适的一个适应度，给后续算法迭代。这里可以推广到存放虚拟机的最优化分配方式。

首先我们要知道PSO粒子群算法是一种启发式算法，是最优化地去解决某个问题，是从鸟群觅食启发得来，鸟类只需要根据附近离食物近的鸟群或者自己飞行的经验来得到食物的最佳位置。每个寻优的一个问题都想象成一只鸟，称为"粒子"，所有粒子都在D维空间进行搜索，所有的粒子都通过一个fitness function确定适应值来判断当前得到的位置的好坏。每一个粒子都要有记忆功能，记忆每一次的最佳位置。每一个粒子还有一个速度以决定飞行的距离和方向，这个速度根据它本身的飞行经验以及同伴的飞行经验进行动态调整。

![](https://img-blog.csdnimg.cn/20190219135023715.png)

![](https://img-blog.csdnimg.cn/20190219135100695.png)

**粒子群算法流程**

第1步 在初始化范围内，对粒子群进行随机初始化，包括随机位置和速度

第2步 计算每个粒子的适应值

第3步 更新粒子个体的历史最优位置

第4步 更新粒子群体的历史最优位置

第5步 更新粒子的速度和位置

第6步 若未达到终止条件，则转第2步

粒子群算法流程图如下：

![](https://img-blog.csdnimg.cn/20190219135617832.png)

那么我们现在可以转移到本问题上，我们预测出的下一段时间的不同种类的虚拟机的数量如何最优化地放到服务器当中？

我们预测得到的一系列虚拟机，顺序是随机的，我们一个个放入服务器的时候，某一个服务器放不下的时候当然就要另外再开辟一个新的服务器了，当然我们希望新开的服务器的空间是越多越好，因为代表之前装的虚拟机都在之前的服务器装的比较优化。

那么就把以上的两个条件当做适应度函数，也就是我们的目标函数：1.比较每次装服务器的数量，谁的数量少就是最优。2.如果服务器数量一致，若比较最后一个服务器的空间，谁更少，谁就是更优化的方案。

所以首次适应这个算法就是为了得到PSO算法当中的fitness function，一旦有了适应度函数，我们把预测得到的虚拟机放到一个box当中，然后还有其他n-1个boxes，每个box当中的虚拟机的顺序都是随机的，都不一样，那么我们分配服务器的时候，就让这n组不同顺序的虚拟机分别进行放置操作，设置iterations，每一次迭代都能够获得当前个体的最优解(也就是每个box的最优放法)，但是个体的最优不一定是最优，我们最终要的应该是n组boxes放置的群体最优解。

我们每迭代一次，就要重新计算适应度函数，因为每次迭代，每个box的虚拟机的顺序都在变化，所以，经过m次迭代，我们得到一个Gbest解，这个就是放置的最优情况。

### 异常值去噪

我们一般会遇到不符合实际情况的数据，也就是异常值。

异常值要做去噪处理，可以考虑用差异系数之类的。时间片切分粒度其实可以尝试多几种切片，数据应该是累积的，因为每条记录就是个请求。无论什么模型参数设定也是很重要的，而且不同flavor预测参数应该都不一样。

简单去躁法比如有 k-近邻法：取某个数据最近的k个近邻点，然后将这个k个值加权（权重一般是距离的比值吧），然后根据自定义的阈值，将距离k个近邻距离超过阈值的当做异常点；稍微复杂一点的有 Grubbs检验，我们就是用的Grubbs_99检验，效果还不错。

ecs文件里面的prediction.py是完整的预测和放置代码，数据在另一个文件夹当中。

最终我们的成绩排在江山赛区初赛74名，比入围复赛的前64名的最后一名，只差了3分，可能代码有些地方不够严谨，算法也可能不是最佳。但是能够学到东西，才是最重要的！
